<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local App Inspector (uiautodev) - Dark</title>
    <style>
        /* --- Global Resets & Font --- */
        :root {
            --dark-bg-primary: #1e1e1e;       /* Very dark - Page background */
            --dark-bg-secondary: #252526;   /* Dark - Panel backgrounds, headers */
            --dark-bg-tertiary: #2d2d2d;    /* Medium Dark - Inputs, some panel areas */
            --dark-bg-hover: #3e3e40;       /* Hover states */
            --dark-bg-active: #4f4f52;      /* Active/selected states */
            
            --dark-border-primary: #3f3f41;   /* Borders for panels, inputs */
            --dark-border-secondary: #505050; /* Softer borders */

            --dark-text-primary: #d4d4d4;     /* Light gray - Main text */
            --dark-text-secondary: #cccccc;   /* Medium gray - Dimmer text */
            --dark-text-placeholder: #777777;/* Placeholder text */

            --dark-accent-primary: #007acc;   /* Blue - Primary accent (buttons, highlights) */
            --dark-accent-hover: #005fab;     /* Darker Blue - Accent hover */
            
            --dark-success: #4CAF50;
            --dark-warning: #ffeb3b; /* Consider a more readable yellow for dark bg */
            --dark-error: #f44336;

            --font-family-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-family-monospace: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
            font-size: 14px;
        }

        header {
            background-color: var(--dark-bg-secondary);
            color: var(--dark-text-primary);
            padding: 12px 20px;
            text-align: center;
            border-bottom: 1px solid var(--dark-border-primary);
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        header h1 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 500;
        }

        #message-area {
            padding: 8px 15px;
            background-color: var(--dark-bg-tertiary);
            border-bottom: 1px solid var(--dark-border-primary);
            text-align: center;
            font-size: 0.9em;
            color: var(--dark-text-secondary);
            flex-shrink: 0;
        }
        #message-area .error { color: var(--dark-error); }
        #message-area .success { color: var(--dark-success); }


        /* --- Main 3-Column Layout --- */
        .main-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Important for fixed height layout */
            padding: 10px;
            gap: 10px;
        }

        .panel {
            background-color: var(--dark-bg-secondary);
            border: 1px solid var(--dark-border-primary);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Children will handle their own scrolling */
        }

        #panel-device-view { /* Left panel for device screen */
            flex: 0 0 38%; /* Adjust as needed, e.g., 400px or percentage */
            min-width: 350px;
        }

        #panel-properties { /* Middle panel for element properties */
            flex: 0 0 30%;
            min-width: 300px;
        }

        #panel-hierarchy-code { /* Right panel for hierarchy & python tabs */
            flex: 1; /* Takes remaining space */
            min-width: 300px;
        }
        
        .panel-title {
            font-size: 1.1em;
            font-weight: 600;
            margin: -15px -15px 15px -15px; /* Extend to panel edges */
            padding: 10px 15px;
            color: var(--dark-text-primary);
            border-bottom: 1px solid var(--dark-border-primary);
            background-color: #333333; /* Slightly different header bg for panels */
            border-radius: 6px 6px 0 0;
        }


        /* --- Device Selection & Controls (Inside #panel-device-view) --- */
        .device-selection-area {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--dark-border-secondary);
        }
        .device-selection-area label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--dark-text-secondary);
        }
        #device-select {
            width: 100%;
            padding: 8px 10px;
            background-color: var(--dark-bg-tertiary);
            color: var(--dark-text-primary);
            border: 1px solid var(--dark-border-primary);
            border-radius: 4px;
            font-size: 0.95em;
        }
        #device-select:focus {
            border-color: var(--dark-accent-primary);
            outline: none;
        }

        .device-screen-container {
            flex-grow: 1; /* Allow this to take available space in its panel */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* Ensure it has some height */
            position: relative; 
            background-color: var(--dark-bg-primary); /* Darker backdrop for the screen */
            border-radius: 4px;
            overflow: hidden; /* Important if image/canvas try to break out */
            margin-bottom: 10px;
        }
        
        #current-device-screen, #overlayCanvas {
            max-width: 100%;
            max-height: 100%;
            height: auto;    
            width: auto;     
            border-radius: 3px;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        #current-device-screen {
            border: 1px solid var(--dark-border-secondary);
            z-index: 1;
        }
        #overlayCanvas {
            z-index: 2; 
            cursor: crosshair;
        }
        /* Tooltip is positioned by JS relative to device-screen-container */

        .device-controls {
            text-align: center;
            padding-top: 10px;
            border-top: 1px solid var(--dark-border-secondary);
            display: flex;
            justify-content: space-around;
            gap: 8px;
        }
        .device-controls button {
            padding: 8px 12px;
            border: 1px solid var(--dark-border-primary);
            background-color: var(--dark-bg-tertiary);
            color: var(--dark-text-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            flex-grow: 1;
        }
        .device-controls button:hover {
            background-color: var(--dark-accent-hover);
            border-color: var(--dark-accent-primary);
            color: white;
        }


        /* --- Tabs (Inside #panel-hierarchy-code or #panel-properties) --- */
        .tabs {
            display: flex;
            margin-bottom: 0; /* Tabs flush with panel content */
            border-bottom: 1px solid var(--dark-border-primary);
            flex-shrink: 0;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: transparent; /* Tabs blend initially */
            border: none;
            border-bottom: 3px solid transparent; /* For active indicator */
            color: var(--dark-text-secondary);
            transition: color 0.2s ease, border-color 0.2s ease;
            margin-right: 2px;
            font-size: 0.95em;
        }
        .tab-button.active {
            color: var(--dark-accent-primary);
            font-weight: 600;
            border-bottom-color: var(--dark-accent-primary);
        }
        .tab-button:hover:not(.active) {
            color: var(--dark-text-primary);
        }

        .tab-content {
            display: none; /* JS handles display:flex */
            flex-grow: 1;
            flex-direction: column;
            padding: 15px 0 0 0; /* Padding for content below tabs */
            overflow: hidden; /* Allow children to scroll */
        }
        .tab-content.active {
            display: flex;
        }

        /* --- Inspector Panel Content (Inside #panel-properties or a tab in #panel-hierarchy-code) --- */
        /* Element Properties */
        #element-properties-view, #generated-xpath-container {
            font-size: 0.9em;
            overflow-y: auto; /* Scroll properties if they overflow */
            flex-grow: 1; /* Allow properties to take space */
        }
        #element-properties-view h4, #generated-xpath-container h4 { /* Assuming you'll wrap XPath in a container with h4 */
            font-size: 1em;
            color: var(--dark-text-secondary);
            margin-top: 0;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--dark-border-secondary);
        }
        .properties-panel table { /* Used by displayNodeProperties */
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }
        .properties-panel th, .properties-panel td {
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid var(--dark-border-primary);
            vertical-align: top;
        }
        .properties-panel th {
            background-color: var(--dark-bg-tertiary);
            color: var(--dark-text-secondary);
            width: 35%; /* Adjust for key column width */
            font-weight: normal;
        }
        .properties-panel td {
            word-break: break-all; /* Break long property values */
        }
        #generated-xpath {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--dark-border-primary);
            border-radius: 4px;
            background-color: var(--dark-bg-tertiary);
            color: var(--dark-text-primary);
            font-family: var(--font-family-monospace);
            margin-top: 5px;
        }

        /* Hierarchy Panel (Inside #panel-hierarchy-code or #panel-left) */
        .hierarchy-panel-container { /* New wrapper for title + tree */
             display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;
        }
        #hierarchy-tree-view {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px; /* For scrollbar */
            font-size: 0.9em;
        }
        #hierarchy-tree-view ul { list-style-type: none; padding-left: 15px; margin: 0; }
        #hierarchy-tree-view li { padding: 4px 2px; cursor: pointer; border-radius: 3px; }
        #hierarchy-tree-view li:hover { background-color: var(--dark-bg-hover); }
        #hierarchy-tree-view .selected-node { 
            background-color: var(--dark-accent-primary); 
            color: white; 
            font-weight: 500;
        }
        #hierarchy-tree-view .selected-node small { color: #e0e0e0; }
        #hierarchy-tree-view small { color: var(--dark-text-secondary); }
        
        /* Interactive Python (Inside a tab in #panel-hierarchy-code) */
        #interactive-python-editor {
            width: 100%; /* Fill parent */
            height: 200px; /* Or use flex-grow if it's the main element */
            border: 1px solid var(--dark-border-primary);
            background-color: #1c1c1c; /* Darker editor background */
            color: var(--dark-text-primary);
            padding: 10px;
            margin-bottom: 10px;
            font-family: var(--font-family-monospace);
            font-size: 13px;
            border-radius: 4px;
            resize: vertical; 
        }
        #run-python-button {
            padding: 8px 15px; 
            margin-bottom: 10px; 
            align-self: flex-start;
        }
        #interactive-python-output {
            flex-grow: 1;
            border: 1px solid var(--dark-border-primary);
            background-color: var(--dark-bg-primary); 
            color: var(--dark-text-secondary); 
            padding: 10px;
            white-space: pre-wrap; 
            overflow-y: auto; 
            font-family: var(--font-family-monospace); 
            font-size: 12px;
            border-radius: 4px;
            min-height: 100px; 
        }
        /* Remove old panel styles if they are no longer used or conflict */
        .left-panel, .right-panel { display:none; } /* Hide old two-panel structure */

    </style>
</head>
<body>
    <header>
        <h1>Local App Inspector (uiautodev) - Dark Mode</h1>
    </header>

    <div id="message-area">Initializing...</div>

    <div class="main-container">
        <div id="panel-device-view" class="panel">
            <h3 class="panel-title">Device View</h3>
            <div class="device-selection-area">
                <label for="device-select">Select Device:</label>
                <select id="device-select"> 
                    <option value="">Loading devices...</option>
                </select>
                </div>
            
            <div class="device-screen-container">
                <img id="current-device-screen" src="https://placehold.co/360x640/2d2d2d/777?text=Device+Screen" alt="Device Screen">
                <canvas id="overlayCanvas"></canvas>
                </div>
            <div class="device-controls">
                <button id="refresh-screen-btn" title="Refresh Screenshot">🔄 Screen</button>
                <button id="device-home-btn" title="Press Home Button">🏠 Home</button>
                <button id="device-back-btn" title="Press Back Button">⬅️ Back</button>
            </div>
        </div>

        <div id="panel-properties" class="panel">
            <h3 class="panel-title">Element Inspector</h3>
            <h4>Selected Element Properties</h4>
            <div id="element-properties-view">Select an element from the screenshot or hierarchy.</div>
            <h4 style="margin-top: 15px;">Generated XPath</h4>
            <input type="text" id="generated-xpath" readonly placeholder="XPath will appear here">
        </div>

        <div id="panel-hierarchy-code" class="panel">
            <div class="tabs">
                <button class="tab-button" onclick="window.openTab(event, 'hierarchy-tab-content')">UI Hierarchy</button>
                <button class="tab-button" onclick="window.openTab(event, 'python-tab-content')">Python Console</button>
            </div>

            <div id="hierarchy-tab-content" class="tab-content">
                <div class="panel-title" style="margin-top:0; border-radius:0; background-color: transparent; border-bottom: 1px solid var(--dark-border-secondary); padding-left:0; padding-right:0;">
                    Element Tree
                    <button id="refresh-hierarchy-btn" style="float: right; font-size:0.8em; padding: 3px 8px;" title="Refresh UI Hierarchy">🔄 Refresh</button>
                </div>
                <div id="hierarchy-tree-view" style="padding-top:10px; flex-grow:1; overflow-y:auto;">Hierarchy will load here...</div>
            </div>

            <div id="python-tab-content" class="tab-content">
                <div class="panel-title" style="margin-top:0; border-radius:0; background-color: transparent; border-bottom: 1px solid var(--dark-border-secondary); padding-left:0; padding-right:0;">Interactive Python</div>
                <textarea id="interactive-python-editor" placeholder="Enter Python code here (e.g., print(d.info) or d.shell('ls'))"></textarea>
                <button id="run-python-button">▶️ Run Code</button>
                <div id="interactive-python-output"># Output will appear here...</div>
            </div>
        </div>
    </div>

    <script src="/static/local_inspector.js"></script> 
    <script>
        // This openTab function should ideally be part of local_inspector.js 
        // or ensured to be globally available before local_inspector.js tries to use it.
        // For now, local_inspector.js has a fallback if window.openTab isn't defined.
        // If you keep this here, ensure local_inspector.js's DOMContentLoaded is correctly handling it.
        
        // Initialize default tab after DOM is ready (local_inspector.js will handle its own init)
        document.addEventListener('DOMContentLoaded', function() {
            // The tab initialization is now handled at the end of local_inspector.js
            // to ensure window.openTab (defined in JS) is available.
            // You can trigger the default tab opening from there or by calling it here if needed.
             if (window.openTab) { // Check if openTab from local_inspector.js is ready
                const initialTab = 'hierarchy-tab-content'; // Or 'python-tab-content'
                const initialTabButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => {
                    const onclickAttr = btn.getAttribute('onclick');
                    return onclickAttr && (onclickAttr.includes("'" + initialTab + "'") || onclickAttr.includes('"' + initialTab + '"'));
                });
                if (initialTabButton) {
                    window.openTab({ currentTarget: initialTabButton }, initialTab);
                } else {
                    // Fallback to first tab if specific one not found
                    const firstButton = document.querySelector('#panel-hierarchy-code .tab-button');
                    if(firstButton) firstButton.click();
                }
            }
        });
    </script>
</body>
</html>
