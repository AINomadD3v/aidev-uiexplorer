<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local App Inspector (uiautodev) - Dark</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">

    <style>
        /* --- Global Resets & Font --- */
        :root { /* Same dark theme variables as before */
            --dark-bg-primary: #1e1e1e; --dark-bg-secondary: #252526; --dark-bg-tertiary: #2d2d2d;
            --dark-bg-hover: #3a3d41; --dark-bg-active: #007acc; --dark-border-primary: #3f3f41;
            --dark-border-secondary: #505050; --dark-text-primary: #d4d4d4; --dark-text-secondary: #cccccc;
            --dark-text-placeholder: #777777; --dark-accent-primary: #007acc; --dark-accent-hover: #005fab;
            --dark-success: #4CAF50; --dark-warning: #ffc107; --dark-error: #f44336;
            --font-family-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-family-monospace: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }
        * { box-sizing: border-box; }
        body { /* Dark theme applied by default */
            font-family: var(--font-family-main); margin: 0; padding: 0; display: flex; flex-direction: column;
            height: 100vh; background-color: var(--dark-bg-primary); color: var(--dark-text-primary); font-size: 13px; 
        }
        header {
            background-color: var(--dark-bg-secondary); color: var(--dark-text-primary); padding: 10px 20px; text-align: center;
            border-bottom: 1px solid var(--dark-border-primary); flex-shrink: 0;
        }
        header h1 { margin: 0; font-size: 1.25em; font-weight: 500; }
        #message-area { display: none; /* Kept in DOM for JS, but hidden */ }

        .main-container { display: flex; flex-grow: 1; overflow: hidden; padding: 8px; gap: 8px; }
        .panel {
            background-color: var(--dark-bg-secondary); border: 1px solid var(--dark-border-primary);
            border-radius: 4px; padding: 0; display: flex; flex-direction: column; overflow: hidden;
        }
        
        .panel-header {
            font-size: 0.95em; font-weight: 500; padding: 8px 12px; color: var(--dark-text-secondary);
            border-bottom: 1px solid var(--dark-border-primary); background-color: #303031; 
            border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .panel-body { padding: 10px; flex-grow: 1; overflow: auto; display: flex; flex-direction: column; }

        #panel-device-view { flex: 0 0 30%; min-width: 300px; max-width: 420px; }
        #panel-properties { flex: 0 0 35%; min-width: 280px; }
        #panel-hierarchy-code { flex: 1; min-width: 250px; }
        
        .device-selection-header-button { background: none; border: none; color: var(--dark-text-secondary); cursor: pointer; padding: 2px 6px; font-size: 1.1em; border-radius: 3px; line-height: 1;}
        .device-selection-header-button:hover { background-color: var(--dark-bg-hover); }
        .device-selection-area { margin: 10px 0; padding: 10px; background-color: var(--dark-bg-tertiary); border: 1px solid var(--dark-border-secondary); border-radius: 4px;}
        .device-selection-area.collapsed { display: none; }
        .device-selection-area label { display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--dark-text-secondary); }
        #device-select { width: 100%; padding: 7px 10px; background-color: var(--dark-bg-tertiary); color: var(--dark-text-primary); border: 1px solid var(--dark-border-primary); border-radius: 4px; font-size: 0.9em; }
        #device-select:focus { border-color: var(--dark-accent-primary); outline: none; box-shadow: 0 0 0 1px var(--dark-accent-primary); }

        .device-screen-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; min-height: 250px; position: relative; background-color: #000; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        #current-device-screen, #overlayCanvas { max-width: 100%; max-height: 100%; height: auto; width: auto; border-radius: 0px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #current-device-screen { border: none; z-index: 1; }
        #overlayCanvas { z-index: 2; cursor: crosshair; }

        .device-controls { text-align: center; padding-top: 10px; border-top: 1px solid var(--dark-border-secondary); display: flex; justify-content: space-around; gap: 8px; flex-shrink: 0; }
        .device-controls button { padding: 7px 10px; font-size: 0.85em; border: 1px solid var(--dark-border-primary); background-color: var(--dark-bg-tertiary); color: var(--dark-text-primary); border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; flex-grow: 1; }
        .device-controls button:hover { background-color: var(--dark-accent-hover); border-color: var(--dark-accent-primary); color: white; }

        .tabs { display: flex; margin-bottom: 0; border-bottom: 1px solid var(--dark-border-primary); flex-shrink: 0; background-color: var(--dark-bg-secondary) }
        .tab-button { padding: 8px 14px; cursor: pointer; background-color: transparent; border: none; border-bottom: 2px solid transparent; color: var(--dark-text-secondary); transition: color 0.2s ease, border-color 0.2s ease; margin-right: 1px; font-size: 0.9em; }
        .tab-button.active { color: var(--dark-accent-primary); font-weight: 500; border-bottom-color: var(--dark-accent-primary); }
        .tab-button:hover:not(.active) { color: var(--dark-text-primary); background-color: var(--dark-bg-hover); }

        .tab-content { display: none; flex-grow: 1; flex-direction: column; padding: 10px; overflow: hidden; }
        .tab-content.active { display: flex; }

        #panel-properties .panel-body { padding: 0; } 
        #element-properties-view, #generated-xpath-container { font-size: 0.85em; overflow-y: auto; flex-grow: 1; padding:10px; }
        #element-properties-view h4, #generated-xpath-container h4 { font-size: 0.95em; color: var(--dark-text-secondary); margin-top: 0; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid var(--dark-border-secondary); font-weight:500; }
        .properties-panel table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .properties-panel th, .properties-panel td { text-align: left; padding: 4px 6px; border-bottom: 1px solid var(--dark-border-primary); vertical-align: top; }
        .properties-panel th { background-color: var(--dark-bg-tertiary); color: var(--dark-text-secondary); width: 30%; font-weight: normal; }
        .properties-panel td { word-break: break-all; color: var(--dark-text-primary); }
        #generated-xpath { width: 100%; padding: 7px; border: 1px solid var(--dark-border-primary); border-radius: 4px; background-color: var(--dark-bg-tertiary); color: var(--dark-text-primary); font-family: var(--font-family-monospace); margin-top: 5px; font-size: 0.9em; }
        
        .tab-panel-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; margin-bottom: 8px; border-bottom: 1px solid var(--dark-border-secondary); font-size: 0.95em; color: var(--dark-text-secondary); font-weight: 500; flex-shrink: 0; }
        #refresh-hierarchy-btn { padding: 3px 7px; font-size: 0.9em; background-color: var(--dark-bg-tertiary); color: var(--dark-text-primary); border: 1px solid var(--dark-border-primary); border-radius: 4px; }
        #refresh-hierarchy-btn:hover { background-color: var(--dark-accent-hover); border-color: var(--dark-accent-primary); color:white; }

        #hierarchy-search-input { width: 100%; padding: 6px 8px; margin-bottom: 10px; background-color: var(--dark-bg-tertiary); color: var(--dark-text-primary); border: 1px solid var(--dark-border-primary); border-radius: 4px; font-size: 0.9em; }
        #hierarchy-search-input:focus { border-color: var(--dark-accent-primary); outline: none; }
        #hierarchy-tree-view { flex-grow: 1; overflow: auto; font-size: 0.85em; font-family: var(--font-family-monospace); line-height: 1.65; padding-right: 5px; padding-bottom: 5px; }
        #hierarchy-tree-view > ul { min-width: 100%; width: max-content; }
        #hierarchy-tree-view ul { list-style-type: none; padding-left: 0; margin: 0; } /* Identical to original */
        /* ... (rest of your original hierarchy tree styles remain identical) ... */
        #hierarchy-tree-view li { position: relative; }
        #hierarchy-tree-view li .node-content { display: flex; align-items: center; padding: 1px 3px; border-radius: 3px; cursor: default; }
        #hierarchy-tree-view li .toggle { display: inline-block; width: 18px; height: 18px; text-align: center; line-height: 18px; margin-right: 2px; color: var(--dark-text-placeholder); cursor: pointer; font-family: var(--font-family-main); user-select: none; }
        #hierarchy-tree-view li .toggle.spacer { visibility: hidden; }
        #hierarchy-tree-view li .toggle:hover { color: var(--dark-accent-primary); }
        #hierarchy-tree-view li ul.collapsed { display: none; }
        #hierarchy-tree-view li ul { margin-left: 12px; padding-left: 10px; border-left: 1px dotted var(--dark-border-secondary); }
        #hierarchy-tree-view > ul { border-left: none; padding-left: 0; }
        #hierarchy-tree-view > ul > li > ul { margin-left: 12px; padding-left: 10px; border-left: 1px dotted var(--dark-border-secondary); }
        #hierarchy-tree-view li .node-text-wrapper { padding: 1px 3px; border-radius: 2px; cursor: pointer; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #hierarchy-tree-view li .node-content:hover > .node-text-wrapper { background-color: var(--dark-bg-hover); }
        #hierarchy-tree-view li.tree-node-selected > .node-content { background-color: var(--dark-accent-primary) !important; }
        #hierarchy-tree-view li.tree-node-selected > .node-content > .node-text-wrapper,
        #hierarchy-tree-view li.tree-node-selected > .node-content > .node-text-wrapper small,
        #hierarchy-tree-view li.tree-node-selected > .node-content > .toggle { color: white !important; }
        #hierarchy-tree-view small { color: #808080; font-size: 0.9em; }
        body.dark-theme #hierarchy-tree-view small { color: #6a6a6a; } 

        /* Styles for CodeMirror 5 */
        .CodeMirror { /* This is the main class for CodeMirror 5 editors */
            height: 200px; /* Desired height */
            border: 1px solid var(--dark-border-primary);
            border-radius: 4px;
            font-family: var(--font-family-monospace) !important; /* Ensure monospace font */
            font-size: 13px !important; /* Ensure font size */
            line-height: 1.4; /* Adjust for readability */
            margin-bottom: 10px; /* Match original textarea margin */
            width: 100%; /* Take full width */
        }
        /* Ensure the chosen CM5 theme applies correctly for dark mode */
        .cm-s-material-darker.CodeMirror { /* Target specific theme */
            background-color: var(--dark-bg-tertiary);
            color: var(--dark-text-primary);
        }
        .cm-s-material-darker .CodeMirror-gutters {
            background: var(--dark-bg-secondary) !important; /* Gutter background */
            border-right: 1px solid var(--dark-border-primary);
        }
        .cm-s-material-darker .CodeMirror-linenumber {
            color: var(--dark-text-placeholder); /* Line number color */
        }
        .cm-s-material-darker .CodeMirror-cursor {
            border-left: 1px solid var(--dark-text-primary) !important; /* Cursor color */
        }
        .cm-s-material-darker .CodeMirror-activeline-background {
            background: var(--dark-bg-hover) !important; /* Active line background */
        }
        .cm-s-material-darker .CodeMirror-selected {
            background: var(--dark-bg-active) !important; /* Selection background */
            color: white !important;
        }


        #run-python-button { padding: 8px 15px; margin-bottom: 10px; align-self: flex-start; }
        #interactive-python-output { flex-grow: 1; border: 1px solid var(--dark-border-primary); background-color: var(--dark-bg-primary); color: var(--dark-text-secondary); padding: 10px; white-space: pre-wrap; overflow-y: auto; font-family: var(--font-family-monospace); font-size: 12px; border-radius: 4px; min-height: 100px; }
    </style>
</head>
<body class="dark-theme"> 
    <header><h1>Local App Inspector</h1></header>
    <div id="message-area" style="display: none;">Initializing...</div>
    <div class="main-container">
        <div id="panel-device-view" class="panel">
            <div class="panel-header">
                <span>Device View</span>
                <button id="toggle-device-select-btn" class="device-selection-header-button" title="Toggle Device Selection">⚙️</button>
            </div>
            <div class="panel-body">
                <div id="device-selection-area-collapsible" class="device-selection-area collapsed">
                    <label for="device-select">Select Device:</label>
                    <select id="device-select"><option value="">Loading devices...</option></select>
                </div>
                <div class="device-screen-container">
                    <img id="current-device-screen" src="https://placehold.co/320x680/1e1e1e/777?text=Device+Screen" alt="Device Screen">
                    <canvas id="overlayCanvas"></canvas>
                </div>
                <div class="device-controls">
                    <button id="refresh-screen-btn" title="Refresh Screenshot">🔄 Screen</button>
                    <button id="device-home-btn" title="Press Home Button">🏠 Home</button>
                    <button id="device-back-btn" title="Press Back Button">⬅️ Back</button>
                </div>
            </div>
        </div>
        <div id="panel-properties" class="panel">
            <div class="panel-header">Element Details</div>
            <div class="panel-body"> 
                <h4>Selected Element Properties</h4>
                <div id="element-properties-view">Select an element to see its properties.</div>
                <h4 style="margin-top: 15px;">Generated XPath</h4>
                <input type="text" id="generated-xpath" readonly placeholder="XPath will appear here">
            </div>
        </div>

        <div id="panel-hierarchy-code" class="panel">
            <div class="tabs"> 
                <button class="tab-button active" onclick="window.openTab(event, 'hierarchy-tab-content')">UI Hierarchy</button>
                <button class="tab-button" onclick="window.openTab(event, 'python-tab-content')">Python Console</button>
            </div>
            <div id="hierarchy-tab-content" class="tab-content active"> 
                <input type="text" id="hierarchy-search-input" placeholder="Search by name, text, ID, desc...">
                <div class="tab-panel-header" style="margin-top: 8px;"> 
                    <span>Element Tree</span>
                    <button id="refresh-hierarchy-btn" title="Refresh Screen & Hierarchy">🔄 Sync All</button>
                </div>
                <div id="hierarchy-tree-view">Select a device and load hierarchy...</div>
            </div>
            <div id="python-tab-content" class="tab-content">
                <div class="tab-panel-header">Interactive Python</div>
                <textarea id="interactive-python-editor" placeholder="Enter Python code here (e.g., print(d.info) or d.shell('ls'))"></textarea>
                <button id="run-python-button">▶️ Run Code</button>
                <div id="interactive-python-output"># Output will appear here...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/vim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    
    <script src="/static/local_inspector.js"></script> 
    <script>
        // This existing script for the device toggle should remain as is
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-device-select-btn');
            const deviceMenu = document.getElementById('device-selection-area-collapsible');
            if (toggleBtn && deviceMenu) {
                toggleBtn.addEventListener('click', function() {
                    deviceMenu.classList.toggle('collapsed');
                });
            }
        });
    </script>
</body>
</html>
